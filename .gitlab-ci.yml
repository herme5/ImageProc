variables:
  LC_ALL: "en_US.UTF-8" # Needed for xcpretty to work

stages:
  - test
  - release

Test:
  stage: test
  parallel:
    matrix:
      - DESTINATION:
        - 'platform=iOS Simulator,name=iPad (10th generation)'
        - 'platform=iOS Simulator,name=iPhone 14'
  script:
    - xcodebuild clean -project ImageProc.xcodeproj -scheme ImageProc | xcpretty
    - xcodebuild test -project ImageProc.xcodeproj -scheme ImageProcTests -destination "$DESTINATION" | xcpretty -s

Release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG                  # Run this job when a tag is created manually
  script:
    - echo "Publishing ImageProc $CI_COMMI_TAG ($COCOAPODS_TRUNK_TOKEN)"
    - pod trunk register andrea.ruffino@hotmail.fr --description='CI Automation'
    - pod spec lint ImageProc.podspec
    - pod trunk push
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'Release $CI_COMMIT_TAG'
    description: 'Release created using the release-cli.'
